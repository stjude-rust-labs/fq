name: Continuous deployment

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  create:
    name: Create release
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create --verify-tag "$GITHUB_REF_NAME"

  build:
    needs: ["create"]

    name: Build release on ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - { os: macos-15, target: aarch64-apple-darwin }
          - { os: macos-15-intel, target: x86_64-apple-darwin }
          - { os: windows-2022, target: x86_64-pc-windows-msvc }
          - { os: ubuntu-22.04, target: x86_64-unknown-linux-gnu }

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install toolchain
        run: |
          rustup set profile minimal
          rustup toolchain install stable-${{ matrix.target }}

      - name: Build release
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Package artifacts
        env:
          TARGET: ${{ matrix.target }}
          CRATE_NAME: fq
          OS_NAME: ${{ matrix.os }}
        shell: bash
        run: |
          dst="$(.github/scripts/before_deploy.sh)"
          echo "ASSET_SRC=$dst" >> $GITHUB_ENV

      - name: Upload archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh release upload "$GITHUB_REF_NAME" ${{ env.ASSET_SRC }}
